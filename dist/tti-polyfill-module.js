(function(){var DEBUG=false;function e(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function l(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:e(a)}}function m(a){if(!(a instanceof Array)){a=l(a);for(var b,c=[];!(b=a.next()).done;)c.push(b.value);a=c}return a}var n="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this,p=0,r={},t,v;
function w(a){r.send=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=t=function(b){for(var c=[],d=0;d<arguments.length;++d)c[d]=arguments[d];var g=this,f=p++;a.l(f);this.addEventListener("readystatechange",function(){4===g.readyState&&a.g(f)});return r.send.apply(this,c)}}
function x(a){r.fetch=fetch;fetch=v=function(b){for(var c=[],d=0;d<arguments.length;++d)c[d]=arguments[d];return new Promise(function(g,f){var h=p++;a.l(h);r.fetch.apply(r,m(c)).then(function(k){a.g(h);g(k)},function(k){a.g(h,k);f(k)})})}}var y="img script iframe link audio video source".split(" ");function z(a,b){a=l(a);for(var c=a.next();!c.done;c=a.next())if(c=c.value,b.includes(c.nodeName.toLowerCase())||c.children&&z(c.children,b))return!0;return!1}
function A(a){var b=new MutationObserver(function(c){c=l(c);for(var d=c.next();!d.done;d=c.next())d=d.value,"childList"==d.type&&z(d.addedNodes,y)?a(d):"attributes"==d.type&&y.includes(d.target.tagName.toLowerCase())&&a(d)});b.observe(document,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["href","src"]});return b}function B(a){for(var b=[],c=0;c<arguments.length;++c)b[c]=arguments[c];DEBUG&&console.log.apply(console,m(b))}function C(a){return 1E3*(4*Math.pow(Math.E,a/1E3*-.045)+1)}
function D(a,b){function c(){250<k.end-k.start&&(f=Math.max(f,k.end),h=C(f-a))}var d=a+5E3,g=b.filter(function(u){return u.start>d});b=b.filter(function(u){return u.start<=d});var f=0===b.length?a:b[b.length-1].end;if(0===g.length)return f;var h,k={start:f-1E3,end:f};c();for(b=0;b<g.length;b++){var q=g[b];if(q.start<k.end+1E3)k.end=q.end,c();else if(q.start>f+h)break;else k={start:q.start,end:q.end},c()}return f}
function E(a,b){if(2<a.length)return performance.now();var c=[];b=l(b);for(var d=b.next();!d.done;d=b.next())d=d.value,c.push({timestamp:d.start,type:"requestStart"}),c.push({timestamp:d.end,type:"requestEnd"});b=l(a);for(d=b.next();!d.done;d=b.next())c.push({timestamp:d.value,type:"requestStart"});c.sort(function(g,f){return g.timestamp-f.timestamp});a=a.length;for(b=c.length-1;0<=b;b--)switch(d=c[b],d.type){case "requestStart":a--;break;case "requestEnd":a++;if(2<a)return d.timestamp;break;default:throw Error("Internal Error: This should never happen");
}return 0}function F(){}
function G(a){var b=this;a=void 0===a?{}:a;this.setTimeout=a.setTimeout||setTimeout;this.clearTimeout=a.clearTimeout||clearTimeout;this.D=!!a.useMutationObserver;this.A=a.minValue||null;var c=a.__tti&&a.__tti.e;a=a.__tti&&a.__tti.o;this.a=[];this.b=[];c&&(B("Consuming the long task & network entries already recorded."),c.forEach(function(d){"longtask"===d.entryType?H(b,d):"resource"===d.entryType&&b.b.push({start:d.fetchStart,end:d.responseEnd})}));a&&a.disconnect();this.c=new Map;this.v=null;this.u=
-Infinity;this.s=!1;this.m=this.i=this.w=null;this.f={l:this.B.bind(this),g:this.G.bind(this)};w(this.f);x(this.f);I(this);this.D&&(this.m=A(this.C.bind(this)))}G.prototype.getFirstConsistentlyInteractive=function(){var a=this;return new Promise(function(b){a.w=b;"complete"==document.readyState?J(a):window.addEventListener("load",function(){J(a)})})};
function J(a){B("Enabling FirstConsistentlyInteractiveDetector");a.s=!0;var b=0<a.a.length?a.a[a.a.length-1].end:0,c=E(a.h,a.b);K(a,Math.max(c+5E3,b))}
function K(a,b){a.s?(B("Attempting to reschedule FirstConsistentlyInteractive check to "+b),B("Previous timer activation time: "+a.u),a.u>b?B("Current activation time is greater than attempted reschedule time. No need to postpone."):(a.clearTimeout(a.v),a.v=a.setTimeout(function(){B("Checking if First Consistently Interactive was reached...");var c=performance.timing.navigationStart,d=E(a.h,a.b),g=(window.a&&window.a.F?1E3*window.a.F().H-c:0)||performance.timing.domContentLoadedEventEnd-c,f=L(a),
h=performance.now();null===f&&(B("No usable minimum value yet. Postponing check."),K(a,Math.max(d+a.j,h+1E3)));B("Parameter values:");B("NavigationStart",c);B("lastKnownNetwork2Busy",d);B("Search Start",g);B("Min Value",f);B("Last busy",d);B("Current time",h);B("Long tasks",a.a);B("Incomplete JS Request Start Times",a.h);B("Network requests",a.b);5E3>h-d?f=null:(c=D(g,a.a),f=h-c<C(c)?null:Math.max(c,f));f?(a.w(f),B("Disabling FirstConsistentlyInteractiveDetector"),a.clearTimeout(a.v),a.s=!1,a.i&&
a.i.disconnect(),a.m&&a.m.disconnect(),r.send&&XMLHttpRequest.prototype.send===t&&(XMLHttpRequest.prototype.send=r.send),r.fetch&&fetch===v&&(fetch=r.fetch),a.f&&(a.f.l=F,a.f.g=F),a.a=[],a.b=[],a.c=new Map):(B("Could not detect First Consistently Interactive. Retrying in 1 second."),K(a,performance.now()+1E3))},b-performance.now()),a.u=b,B("Rescheduled firstConsistentlyInteractive check at "+b))):B("startSchedulingTimerTasks must be called before calling rescheduleTimer")}
function I(a){a.i=new PerformanceObserver(function(b){b=b.getEntries();b=l(b);for(var c=b.next();!c.done;c=b.next()){c=c.value;if("resource"===c.entryType){var d=c;B("Network request finished",d);a.b.push({start:d.fetchStart,end:d.responseEnd});K(a,E(a.h,a.b)+a.j)}"longtask"===c.entryType&&(B("Long task finished",c),c=H(a,c),K(a,c.end+a.j))}});a.i.observe({entryTypes:["longtask","resource"]})}
G.prototype.B=function(a){B("Starting JS initiated request. Request ID: "+a);this.c.set(a,performance.now());B("Active XHRs: "+this.c.size)};G.prototype.G=function(a){B("Completed JS initiated request with request ID: "+a);this.c.delete(a);B("Active XHRs: "+this.c.size)};function H(a,b){b={start:b.startTime,end:b.startTime+b.duration};a.a.push(b);return b}
G.prototype.C=function(a){B("Potentially network resource fetching mutation detected",a);B("Pushing back FirstConsistentlyInteractive check by 5 seconds.");K(this,performance.now()+this.j)};function L(a){return a.A?a.A:performance.timing.domContentLoadedEventEnd?(a=performance.timing,a.domContentLoadedEventEnd-a.navigationStart):null}
n.Object.defineProperties(G.prototype,{h:{configurable:!0,enumerable:!0,get:function(){return[].concat(m(this.c.values()))}},j:{configurable:!0,enumerable:!0,get:function(){var a=L(this);return C(null!==a?performance.now()-a:0)}}});module.exports={getFirstConsistentlyInteractive:function(a){a=void 0===a?{}:a;return"PerformanceLongTaskTiming"in window?(new G(a)).getFirstConsistentlyInteractive():Promise.resolve(null)}};})();
//# sourceMappingURL=tti-polyfill-module.js.map
